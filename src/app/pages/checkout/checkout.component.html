<div class="checkout-container">
  <h1 class="page-title">Thanh toán</h1>

  <div class="checkout-content">
    <!-- Left side - Checkout Form -->
    <div class="checkout-form">
      <!-- Shipping Address Section -->
      <div class="form-section">
        <h2 class="section-title">
          <i class="fa fa-map-marker"></i> Địa chỉ giao hàng
        </h2>

        <!-- Address List -->
        <div class="address-list" *ngIf="userAddresses.length > 0 && !showAddressForm">
          <div *ngFor="let address of userAddresses" class="address-item"
            [class.selected]="address.addressId === selectedAddressId" (click)="setDefaultAddress(address.addressId)">
            <div class="address-content">
              <div class="address-info">
                <div>{{ address.addressLine }}</div>
                <div>{{ address.ward }}, {{ address.district }}, {{ address.city }}</div>
                <span *ngIf="address.isDefault" class="default-label">Mặc định</span>
              </div>
              <div class="address-actions">
                <button class="edit-btn" (click)="toggleAddressForm(true, address); $event.stopPropagation()"><i class="fa fa-edit"></i></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Add New Address Button -->
        <div *ngIf="!showAddressForm" class="add-address-btn" (click)="toggleAddressForm()">
          <i class="fa fa-plus"></i> Thêm địa chỉ mới
        </div>

        <!-- Address Form (Add/Edit) -->
        <div *ngIf="showAddressForm" class="address-form">
          <div class="form-group">
            <label for="addressLine">Địa chỉ</label>
            <input type="text" id="addressLine" [(ngModel)]="newAddress.addressLine" placeholder="Số nhà, tên đường">
          </div>

          <div class="form-group">
            <label for="city">Thành phố</label>
            <input type="text" id="city" [(ngModel)]="newAddress.city" placeholder="Thành phố">
          </div>

          <div class="form-group">
            <label for="district">Quận/Huyện</label>
            <input type="text" id="district" [(ngModel)]="newAddress.district" placeholder="Quận/Huyện">
          </div>

          <div class="form-group">
            <label for="ward">Phường/Xã</label>
            <input type="text" id="ward" [(ngModel)]="newAddress.ward" placeholder="Phường/Xã">
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" [(ngModel)]="newAddress.isDefault"> Đặt làm địa chỉ mặc định
            </label>
          </div>

          <div class="form-actions">
            <button class="cancel-btn" (click)="toggleAddressForm()">Hủy</button>
            <button class="save-btn" (click)="saveAddress()">Lưu địa chỉ</button>
          </div>
        </div>

        <!-- No Addresses Message -->
        <div *ngIf="userAddresses.length === 0 && !showAddressForm">
          <p>Bạn chưa có địa chỉ giao hàng. Vui lòng thêm địa chỉ mới.</p>
          <button class="add-address-btn" (click)="toggleAddressForm()">
            <i class="fa fa-plus"></i> Thêm địa chỉ mới
          </button>
        </div>
      </div>
      <div class="form-section">
        <h2 class="section-title">
          <i class="fa fa-ship"></i> Phương thức vận chuyển
        </h2>
        <!-- Thay thế phần shipping-options bằng code sau -->
        <div class="shipping-options">
          <div *ngFor="let method of shippingMethods" class="shipping-option"
            [class.selected]="selectedShippingMethodId === method.ship_method_id"
            (click)="selectShippingMethod(method.ship_method_id)">
            <div class="shipping-radio">
              <input type="radio" [id]="'shipping-' + method.ship_method_id" [value]="method.ship_method_id"
                [checked]="selectedShippingMethodId === method.ship_method_id"
                (change)="selectShippingMethod(method.ship_method_id)" name="shippingMethod">
            </div>
            <div class="shipping-info">
              <div class="shipping-name">{{ method.methodName }}</div>
              <div class="shipping-description">{{ method.description}}</div>
              <div class="shipping-fee">Phí: {{ method.shippingFee | currency:'VND':'symbol':'1.0-0' }}</div>
            </div>
          </div>
        </div>
      </div>


      <!-- Payment Method Section -->
      <div class="form-section">
        <h2 class="section-title">
          <i class="fa fa-credit-card"></i> Phương thức thanh toán
        </h2>

        <div class="payment-options">
          <div *ngFor="let method of paymentMethods" class="payment-option"
            [class.selected]="paymentMethod === method.code" (click)="paymentMethod = method.code">
            <div class="payment-radio">
              <input type="radio" [id]="'payment-' + method.code" [value]="method.code" [(ngModel)]="paymentMethod"
                name="paymentMethod">
            </div>
            <img *ngIf="method.iconUrl" [src]="method.iconUrl" alt="Payment icon" class="payment-icon">
            <div class="payment-info">
              <div class="payment-name">{{ method.name }}</div>
              <div class="payment-description">{{ method.description }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right side - Order Summary -->
    <div class="order-summary">
      <div class="summary-section">
        <h2 class="section-title">Tóm tắt đơn hàng</h2>

        <!-- Cart Items -->
        <div class="cart-items">
          <div *ngFor="let item of cartItems" class="cart-item">
            <img [src]="getVariantDetails(item.variantId, 'imageUrl')" alt="Product image" class="item-image">
            <div class="item-details">
              <div class="item-name">{{ item.productName }}</div>
              <div class="item-variant">
                Size: {{ getVariantDetails(item.variantId, 'size') }},
                Màu: {{ getVariantDetails(item.variantId, 'color') }}
              </div>
              <div class="item-price">{{ getVariantDetails(item.variantId, 'price') | currency:'VND':'symbol':'1.0-0' }}
              </div>
            </div>
            <div class="item-quantity">x{{ item.quantity }}</div>
          </div>
        </div>

        <!-- Cập nhật phần price summary để hiển thị phí vận chuyển -->
        <div class="price-summary">
          <div class="price-row">
            <div>Tổng tiền hàng:</div>
            <div>{{ totalPrice | currency:'VND':'symbol':'1.0-0' }}</div>
          </div>
          <div class="price-row">
            <div>Phí vận chuyển:</div>
            <div>{{ getShippingFee() | currency:'VND':'symbol':'1.0-0' }}</div>
          </div>
          <div class="price-row total">
            <div>Tổng thanh toán:</div>
            <div>{{ totalPrice + getShippingFee() | currency:'VND':'symbol':'1.0-0' }}</div>
          </div>
        </div>

        <!-- Checkout Button -->
        <button class="checkout-btn"
          [disabled]="!selectedAddressId || !paymentMethod || selectedShippingMethodId === 0 || cartItems.length === 0"
          (click)="placeOrder()">
          Đặt hàng
        </button>
      </div>
    </div>
  </div>
</div>